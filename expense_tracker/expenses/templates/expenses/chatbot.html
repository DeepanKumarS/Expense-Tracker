<div id="chat-widget" 
     style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-family: 'Inter', sans-serif;">
  
  <!-- Chat container -->
  <div id="chat-container" 
       style="display:none; width:340px; height:440px; background:#ffffff; 
              border-radius:20px; box-shadow:0 6px 18px rgba(0,0,0,0.15); 
              overflow:hidden; display:flex; flex-direction:column;">

    <!-- Header -->
    <div style="background:#0078ff; color:white; padding:14px; font-weight:600; 
                display:flex; justify-content:space-between; align-items:center;">
      <span>üí¨ ExpenseBot</span>
      <button id="close-chat" style="background:none; border:none; color:white; font-size:18px; cursor:pointer;">‚úñ</button>
    </div>

    <!-- Chat Messages -->
    <div id="chat-box" 
         style="flex:1; padding:12px; overflow-y:auto; background:#f7f9fc;">
    </div>

    <!-- Input area -->
    <div id="chat-input" 
         style="display:flex; align-items:center; border-top:1px solid #e0e0e0; padding:10px; background:#fff;">
      <input type="text" id="user-input" 
             placeholder="Ask about your expenses..." 
             style="flex:1; border:none; outline:none; font-size:14px; padding:8px; background:#f1f3f6; border-radius:20px;">
      <button id="send-btn" 
              style="background:#0078ff; border:none; color:white; border-radius:50%; width:38px; height:38px; 
                     margin-left:8px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" width="18px" height="18px">
          <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Floating Chat Button -->
  <button id="chat-toggle" 
          style="width:60px; height:60px; border-radius:50%; background:#0078ff; border:none; 
                 color:white; font-size:26px; display:flex; align-items:center; justify-content:center; 
                 box-shadow:0 6px 16px rgba(0,0,0,0.25); cursor:pointer;">
    üí¨
  </button>
</div>

<script>
const toggleBtn = document.getElementById("chat-toggle");
const chatContainer = document.getElementById("chat-container");
const chatBox = document.getElementById("chat-box");
const sendBtn = document.getElementById("send-btn");
const input = document.getElementById("user-input");
const closeBtn = document.getElementById("close-chat");

toggleBtn.onclick = () => {
  chatContainer.style.display = "flex";
  toggleBtn.style.display = "none";
};

closeBtn.onclick = () => {
  chatContainer.style.display = "none";
  toggleBtn.style.display = "flex";
};

sendBtn.onclick = async function() {
  const userMsg = input.value.trim();
  if (!userMsg) return;

  chatBox.innerHTML += `<div style="margin:6px 0; text-align:right;">
                          <span style="background:#0078ff; color:white; padding:8px 12px; border-radius:16px; display:inline-block; max-width:80%;">
                            ${userMsg}
                          </span>
                        </div>`;
  input.value = "";

  try {
    const res = await fetch("/chatbot/", {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/x-www-form-urlencoded" },
      body: `query=${encodeURIComponent(userMsg)}`
    });
    const data = await res.json();

    chatBox.innerHTML += `<div style="margin:6px 0; text-align:left;">
                            <span style="background:#e9efff; color:#222; padding:8px 12px; border-radius:16px; display:inline-block; max-width:80%;">
                              ${data.response}
                            </span>
                          </div>`;
  } catch (err) {
    chatBox.innerHTML += `<div style="color:#d32f2f; font-size:13px;">‚ö†Ô∏è Unable to reach AI service.</div>`;
  }

  chatBox.scrollTop = chatBox.scrollHeight;
};
</script>
